= 第四章  表达式
ifdef::env-github[]
:imagesdir:
 https://gist.githubusercontent.com/path/to/gist/revision/dir/with/all/images
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
ifndef::env-github[]
:imagesdir: ./
endif::[]
:toc:
:toc-placement!:

toc::[]

# 基础
表达式由一个或多个 *运算对象（operand）* 组成，对表达式求值将得到一个结果。
字面值和变量是最简单的 *表达式（expression）*，其结果就是字面值和变量的值。
把一个 *运算符（operator）* 和多个运算对象组合起来就可以生成复杂的表达式。

## 基本概念
根据运算对象的个数划分运算符：

    . 一元运算符：取地址符（&），解引用符（*），一元正负号（+，-）等，优先级最高
    . 二元运算符：相等运算符（==），相乘（*）等
    . 三元运算符：opr1 ? opr2 : opr3 等

*组合运算符* 和 *运算对象*：

    . *优先级（precedence）*
    . *结合律（associativity）*
    . 运算对象的 *求值顺序（order of evaaluation）*

运算对象类型转换：小整数型通常会被提升为大整数型。

*重载运算符*：

. C++语言定义了运算符作用于内置类型和复合类型的运算对象时所执行的操作。
. 当运算符作用于类类型的运算对象时，用户可以自定义其含义——*重载运算符（overloaded operator）*

*左值和右值*：

    . 当对象被用作*右值*的时候，用的是*对象的值（内容*；当对象被用作*左值*的时候，用的是*对象的身份（在内存中的位置）*。
    . 不同的运算符对运算对象的要求各不相同，有的需要左值运算对象，有的需要右值运算对象；返回值也有差异，有的得到左值结果，有的得到右值结果。（需要右值的地方可以使用左值来代替，反之不可）
        .. 赋值运算符需要一个（非常量）左值作为其左侧运算对象，得到的结果仍然是一个左值；
        .. 取地址符作用于一个左值运算对象，返回一个指向该运算对象的指针，该指针是个右值；
        .. 内置解引用运算符、下标运算符、迭代器解引用运算符、string和vector的下标运算符的求值结果都是左值。
        .. 内置类型和迭代器的递增递减运算符作用于左值运算对象，所得的结果也是左值。
        .. 如果表达式的求值结果是左值，decltype作用于该表达式（不是变量）得到一个引用类型

[source,c++]
----
int i = 42, *p = &i , &r = i;
decltype(r) a      //错误：a是int&，必须初始化
decltype(r + 0) b; //正确：加法的结果是int，y绑定到变量x
decltype(*p) c;    //错误：c是int&，必须初始化（因为该表达式*p的求值结果可以作为一条赋值语句的左值）
decltype(i) d;     //正确：d是一个（未初始化的）int
decltype((i))) e;  //错误：e是int&，必须初始化
----

WARNING: `decltype\((variable))` (注意是双层括号)的结果永远是引用，而`decltype(variable)`结果只有variable本身就是一个引用时才是引用。

## 优先级与结合律
*复合表达式（compound expression）* 是指含有两个或多个运算符的表达式。求复合表达式的值需要首先将运算符和运算对象合理地组合在一起，优先级与结合律决定了运算对象的组合方式。高优先级运算符的运算对象要比低优先级运算符的运算对象更为紧密的结合在一起；如果优先级相同，则其组合律由其结合律决定。括号无视优先级和组合律。
[source,c++]
----
int i = 6 + 3 * 4 / 2 + 2;

int ia[] = {0,2,4,6,8};
int last = *(ia + 4);
cout<<last<<endl;
last = *ia + 4;
cout<<last<<endl;

int v1,v2;
cin >> v1 >> v2; //IO相关的运算符满足左结合律
----

## 求值顺序
优先级规定了运算对象的组合方式，但没有说明运算对象要按照什么顺序求值。大多数情况下，不会明确指定求值的顺序：
[source,c++]
----
int i = f1()*f2(); <1>

int j = 0;
cout << i << " "<< ++i <<endl; <2>
----
<1> f1和f2一定会在执行乘法之前被调用，但是无法知道f1和f2谁先调用
<2> 程序是未定义的，因为无法推断其行为：编译器可能先求+\+i的值再求i的值，此时输出1 1，也可能先求i的值再求++i的值，输出结果为0 1

# 算术运算符
表4.1（以及后面章节的运算符表）按照运算符优先级从高到低将其分组。

image::img/table4-1.png[alt=tabel, width=500,align=center]